<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parkplatz-Verwaltung M6</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, "SF Pro Text", BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .occupied {
            background-image: linear-gradient(135deg, #FF6B6B, #FF4D4D);
            color: #FFFFFF;
        }
        .free {
            background-image: linear-gradient(135deg, #48C28D, #37A87A);
            color: #FFFFFF;
        }
        .blocked {
            background-image: linear-gradient(135deg, #4F46E5, #312E81);
            color: #FFFFFF;
        }
        .car-svg {
            color: white;
            font-size: 2.5rem;
        }
        .calendar-day {
            @apply flex items-center justify-center w-10 h-10 rounded-full cursor-pointer;
        }
        .calendar-day.selected {
            @apply bg-blue-500 text-white;
        }
        .calendar-day.current-month {
            @apply text-gray-100;
        }
        .arrow-icon {
            transition: transform 0.3s ease-in-out;
        }
        .arrow-icon.rotated {
            transform: rotate(-90deg);
        }
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
        }
        .chat-user {
            background-color: #3B82F6; /* Blue-600 */
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-assistant {
            background-color: #4B5563; /* Gray-600 */
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-900 p-4 sm:p-8 text-gray-100">
    <!-- Main Application Container -->
    <div class="max-w-4xl mx-auto bg-gray-800 rounded-3xl shadow-lg p-6 sm:p-8">
        <header class="text-center mb-8">
            <img src="WappenLVBLogistik2.jpg" alt="Logistik Logo" class="mx-auto h-20 w-auto mb-4">
            <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight mb-2">Parkplatz-Verwaltung M6</h1>
            <p class="text-gray-400">Verwalten Sie den Status der Parkplätze in Echtzeit.</p>
            <div id="userIdDisplay" class="text-sm text-gray-500 mt-2 break-all"></div>
            
            <!-- Admin View Container -->
            <div id="adminStatusContainer" class="mt-4">
                <button id="adminLoginBtn" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 transition-colors rounded-full font-bold shadow-md">
                    Admin-Login
                </button>
            </div>
        </header>
        
        <!-- Main Application Content -->
        <div id="app-container">
            <!-- Legend for Parkplatz-Typen -->
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-300 mb-4">Legende</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-4 h-4 rounded-full bg-blue-600"></span>
                        <span class="text-sm text-gray-300">LVb Log</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-4 h-4 rounded-full bg-yellow-500"></span>
                        <span class="text-sm text-gray-300">ZIVI</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-4 h-4 rounded-full bg-purple-500"></span>
                        <span class="text-sm text-gray-300">Besucher</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-4 h-4 rounded-full bg-gray-400"></span>
                        <span class="text-sm text-gray-300">Standard</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-4 h-4 rounded-full border-2 border-green-500"></span>
                        <span class="text-sm text-gray-300">Elektro-Ladeplatz</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-4 h-4 rounded-full free"></span>
                        <span class="text-sm text-gray-300">Frei</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-4 h-4 rounded-full occupied"></span>
                        <span class="text-sm text-gray-300">Belegt</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="inline-block w-4 h-4 rounded-full blocked"></span>
                        <span class="text-sm text-gray-300">Gesperrt (Admin)</span>
                    </div>
                </div>
            </div>

            <!-- Calendar and View Switch -->
            <div class="mb-8 bg-gray-900 rounded-3xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <button id="prevMonth" class="text-gray-400 hover:text-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h3 id="currentMonthYear" class="text-xl font-semibold"></h3>
                    <button id="nextMonth" class="text-gray-400 hover:text-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center text-xs text-gray-400 font-medium mb-2">
                    <div>Mo</div><div>Di</div><div>Mi</div><div>Do</div><div>Fr</div><div>Sa</div><div>So</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
            </div>

            <!-- Parking Levels Container -->
            <div id="parking-container" class="space-y-8">
                <!-- Parking Levels will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- Notification Toast -->
        <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-green-500 text-white py-3 px-6 rounded-full shadow-lg transition-all duration-300 opacity-0 transform translate-y-4">
            Buchung erfolgreich!
        </div>

        <!-- Booking Modal -->
        <div id="booking-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-3xl p-8 shadow-xl max-w-sm w-full relative">
                <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h3 id="modal-title" class="text-xl font-semibold mb-4 text-center">Parkplatz buchen</h3>
                <form id="booking-form">
                    <div class="mb-4">
                        <label for="user-name" class="block text-sm font-medium text-gray-400 mb-1">Ihr Name</label>
                        <input type="text" id="user-name" class="w-full px-4 py-2 bg-gray-700 rounded-xl border border-gray-600 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Max Mustermann" required>
                    </div>
                    <div class="mb-4">
                        <label for="license-plate" class="block text-sm font-medium text-gray-400 mb-1">Kennzeichen</label>
                        <input type="text" id="license-plate" class="w-full px-4 py-2 bg-gray-700 rounded-xl border border-gray-600 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="BE 12345" required>
                    </div>
                    <!-- New E-mail confirmation section -->
                    <div class="mb-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="send-email-checkbox" class="h-4 w-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-500">
                            <label for="send-email-checkbox" class="ml-2 text-sm text-gray-400">Bestätigung per E-Mail erhalten?</label>
                        </div>
                    </div>
                    <div id="email-field-container" class="mb-4 hidden">
                        <label for="email-address" class="block text-sm font-medium text-gray-400 mb-1">E-Mail-Adresse</label>
                        <input type="email" id="email-address" class="w-full px-4 py-2 bg-gray-700 rounded-xl border border-gray-600 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="max.mustermann@example.com">
                    </div>
                    <div id="modal-buttons" class="flex justify-between space-x-4 mt-6">
                        <!-- Buttons will be rendered by JS -->
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Password Modal -->
        <div id="admin-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-3xl p-8 shadow-xl max-w-sm w-full relative">
                <button id="close-admin-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h3 class="text-xl font-semibold mb-4 text-center">Admin-Login</h3>
                <form id="admin-login-form">
                    <div class="mb-4">
                        <label for="admin-password" class="block text-sm font-medium text-gray-400 mb-1">Passwort</label>
                        <input type="password" id="admin-password" class="w-full px-4 py-2 bg-gray-700 rounded-xl border border-gray-600 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                    </div>
                    <button type="submit" class="w-full py-3 px-6 bg-purple-600 hover:bg-purple-700 transition-colors rounded-xl font-bold mt-4">
                        Anmelden
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Report Modal -->
        <div id="report-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-3xl p-8 shadow-xl max-w-lg w-full relative">
                <button id="close-report-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h3 class="text-xl font-semibold mb-4 text-center">Parkplatzbericht ✨</h3>
                <div id="report-content" class="text-gray-300 leading-relaxed max-h-[60vh] overflow-y-auto">
                    <!-- Report content will be added here -->
                    <div id="report-loading-spinner" class="text-center py-8 hidden">
                        <svg class="animate-spin h-10 w-10 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-sm text-gray-400">Generiere Bericht...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gemini Assistant Button -->
        <div class="text-center mt-8">
            <button id="assistantBtn" class="mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 transition-colors rounded-full font-bold shadow-md">
                Parkplatz-Assistent ✨
            </button>
        </div>

        <!-- Gemini Chat Modal -->
        <div id="chat-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-3xl p-8 shadow-xl max-w-lg w-full relative flex flex-col h-full max-h-[80vh]">
                <button id="close-chat-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h3 class="text-xl font-semibold mb-4 text-center">Parkplatz-Assistent ✨</h3>
                <div id="chat-messages" class="flex-1 overflow-y-auto mb-4 p-2 space-y-4">
                    <!-- Chat messages will be appended here -->
                </div>
                <form id="chat-form" class="flex items-center gap-2">
                    <input type="text" id="chat-input" class="flex-1 px-4 py-2 bg-gray-700 rounded-xl border border-gray-600 text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ihre Frage hier..." required>
                    <button type="submit" class="p-3 bg-blue-600 hover:bg-blue-700 transition-colors rounded-full font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <address>
                <p>Lehrverband Logistik</p>
                <p>Kommando Lehrverband Logistik</p>
                <p>Malerweg 6</p>
                <p>3602 Thun</p>
                <br>
                <p>+41 58 468 08 11</p>
                <p><a href="mailto:info.lvblog@vtg.admin.ch" class="hover:underline">info.lvblog@vtg.admin.ch</a></p>
            </address>
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, setLogLevel, getDoc, collection, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set debug level for Firestore logging
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Admin-spezifische Konstanten
        const ADMIN_PASSWORD = "admin";
        const BLOCKED_SPOTS_COLLECTION = "blocked-spots";
        const PUBLIC_BOOKINGS_COLLECTION = "public-bookings";
        
        let isAdmin = false;

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;

        let currentDate = new Date();
        let selectedDate = new Date();
        let globalBookings = {}; // Variable to hold fetched booking data
        let globalBlockedSpots = {};
        
        // Gemini API configuration
        const API_KEY = ""; // This will be provided by the environment
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const GEMINI_API_URL_SEARCH = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        // Chat history for the assistant
        let chatHistory = [];
        
        // Use onAuthStateChanged to handle authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userIdDisplay').textContent = `Benutzer-ID: ${userId}`;
                // Initial calendar and data render
                renderCalendar();
                setupRealtimeListeners();
            } else {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error signing in:", error);
                }
            }
        });

        // --- Calendar Logic ---
        const daysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const firstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

        function renderCalendar() {
            const monthNames = ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
            const calendarGrid = document.getElementById('calendar-grid');
            document.getElementById('currentMonthYear').textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            calendarGrid.innerHTML = '';

            const totalDays = daysInMonth(currentDate.getFullYear(), currentDate.getMonth());
            const firstDay = firstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth());
            const startDay = firstDay === 0 ? 6 : firstDay - 1;

            // Add leading empty days
            for (let i = 0; i < startDay; i++) {
                const emptyDiv = document.createElement('div');
                calendarGrid.appendChild(emptyDiv);
            }

            // Add days of the month
            for (let i = 1; i <= totalDays; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.textContent = i;
                dayDiv.className = 'calendar-day current-month';
                dayDiv.dataset.day = i;

                const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                if (dayDate.toDateString() === selectedDate.toDateString()) {
                    dayDiv.classList.add('selected');
                }

                dayDiv.onclick = () => {
                    selectedDate = dayDate;
                    renderCalendar();
                    setupRealtimeListeners();
                };
                calendarGrid.appendChild(dayDiv);
            }
        }
        
        document.getElementById('prevMonth').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        };

        document.getElementById('nextMonth').onclick = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        };

        // --- Parking Data Configuration ---
        const parkingDataConfig = {
            '1.UG': {
                spots: [50, 49, 48, 47, 46, 45, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44],
                lvbLog: [50, 49, 45, 33, 36, 37, 43, 44],
                visitor: [48, 47, 46, 38, 39, 40, 41, 42],
                zivi: [32, 34, 35],
                ev: [36, 38, 39] // EV charging spots
            },
            '2.UG': {
                spots: [119, 118, 117, 116, 115, 114, 113, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112],
                lvbLog: [117, 116, 114, 102, 104, 105, 106, 107, 108, 109, 110, 111, 112],
                visitor: [117, 116, 114, 102, 104, 107],
                zivi: [115]
            }
        };

        // --- Functions to Interact with UI and Firestore ---

        const modal = document.getElementById('booking-modal-backdrop');
        const adminModal = document.getElementById('admin-modal-backdrop');
        const chatModal = document.getElementById('chat-modal-backdrop');
        const reportModal = document.getElementById('report-modal-backdrop');
        const userNameInput = document.getElementById('user-name');
        const licensePlateInput = document.getElementById('license-plate');
        const emailCheckbox = document.getElementById('send-email-checkbox');
        const emailFieldContainer = document.getElementById('email-field-container');
        const emailAddressInput = document.getElementById('email-address');
        const modalButtons = document.getElementById('modal-buttons');
        const toast = document.getElementById('toast');
        const closeModalButton = document.getElementById('close-modal');
        const closeAdminModalButton = document.getElementById('close-admin-modal');
        const closeChatModalButton = document.getElementById('close-chat-modal');
        const closeReportModalButton = document.getElementById('close-report-modal');
        const adminStatusContainer = document.getElementById('adminStatusContainer');
        const assistantBtn = document.getElementById('assistantBtn');
        
        // Toggle email input visibility
        emailCheckbox.addEventListener('change', () => {
            emailFieldContainer.classList.toggle('hidden', !emailCheckbox.checked);
            if (emailCheckbox.checked) {
                emailAddressInput.setAttribute('required', 'required');
            } else {
                emailAddressInput.removeAttribute('required');
                emailAddressInput.value = ''; // Clear value when hidden
            }
        });

        document.getElementById('adminLoginBtn').onclick = () => {
            if (isAdmin) {
                // Logout logic
                isAdmin = false;
                renderHeader();
                showToast("Erfolgreich abgemeldet!");
                renderParkingSpots(globalBookings, globalBlockedSpots);
            } else {
                // Show login modal
                adminModal.classList.remove('hidden');
            }
        };

        closeModalButton.onclick = () => modal.classList.add('hidden');
        closeAdminModalButton.onclick = () => adminModal.classList.add('hidden');
        closeChatModalButton.onclick = () => chatModal.classList.add('hidden');
        closeReportModalButton.onclick = () => reportModal.classList.add('hidden');
        
        assistantBtn.onclick = () => {
            chatModal.classList.remove('hidden');
        };

        document.getElementById('admin-login-form').onsubmit = (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                showToast("Admin-Login erfolgreich!");
                adminModal.classList.add('hidden');
                document.getElementById('admin-password').value = '';
                renderHeader();
                renderParkingSpots(globalBookings, globalBlockedSpots);
            } else {
                showToastError("Falsches Passwort.");
            }
        };

        function renderHeader() {
            if (isAdmin) {
                adminStatusContainer.innerHTML = `
                    <div class="text-green-400 font-bold mb-2">Sie sind als Admin angemeldet.</div>
                    <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <button id="adminLogoutBtn" class="px-6 py-2 bg-red-600 hover:bg-red-700 transition-colors rounded-full font-bold shadow-md">
                            Admin-Logout
                        </button>
                        <button id="exportBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 transition-colors rounded-full font-bold shadow-md">
                            Buchungen exportieren
                        </button>
                        <button id="reportBtn" class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 transition-colors rounded-full font-bold shadow-md">
                            Tagesbericht ✨
                        </button>
                    </div>
                `;
                document.getElementById('adminLogoutBtn').onclick = () => {
                    isAdmin = false;
                    renderHeader();
                    showToast("Erfolgreich abgemeldet!");
                    renderParkingSpots(globalBookings, globalBlockedSpots);
                };
                document.getElementById('exportBtn').onclick = () => exportBookingsToCSV();
                document.getElementById('reportBtn').onclick = () => generateParkingReport();
            } else {
                adminStatusContainer.innerHTML = `
                    <button id="adminLoginBtn" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 transition-colors rounded-full font-bold shadow-md">
                        Admin-Login
                    </button>
                `;
                document.getElementById('adminLoginBtn').onclick = () => {
                    adminModal.classList.remove('hidden');
                };
            }
        }
        
        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-4', 'bg-red-500');
            toast.classList.add('opacity-100', 'translate-y-0', 'bg-green-500');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        }

        function showToastError(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-4', 'bg-green-500');
            toast.classList.add('opacity-100', 'translate-y-0', 'bg-red-500');
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        }

        async function saveBooking(level, spot, timeOfDay, userName, licensePlate, emailAddress) {
            if (!userId) {
                console.error("User not authenticated. Cannot update status.");
                return;
            }

            const dateKey = selectedDate.toISOString().split('T')[0];
            const publicBookingId = `${level}-${spot}-${dateKey}-${timeOfDay}`;
            const publicDocRef = doc(db, "artifacts", appId, "public", "data", PUBLIC_BOOKINGS_COLLECTION, publicBookingId);
            const privateDocRef = doc(db, "artifacts", appId, "users", userId, "parking-data", "parking-status");
            const privateKey = `${level}.${spot}.${dateKey}.${timeOfDay}`;

            try {
                const bookingData = {
                    level,
                    spot,
                    dateKey,
                    timeOfDay,
                    name: userName,
                    license: licensePlate,
                    userId
                };
                if (emailAddress) {
                    bookingData.email = emailAddress;
                    // In a real application, you would now send a confirmation email.
                    // For this demo, we'll just log it.
                    console.log(`Simulating email confirmation to: ${emailAddress} for booking: ${JSON.stringify(bookingData)}`);
                }

                // Save booking data to a public collection for all users and admin to see
                await setDoc(publicDocRef, bookingData);
                
                // Save a small reference to the user's private document for their own history
                await updateDoc(privateDocRef, {
                    [privateKey]: { name: userName, license: licensePlate, bookedAt: new Date().toISOString() }
                });

                modal.classList.add('hidden');
                showToast("Buchung erfolgreich!");
                if (emailAddress) {
                    showToast("Buchung erfolgreich! (E-Mail wird im Backend verarbeitet)");
                }
            } catch (error) {
                console.error("Error updating document:", error);
                showToastError("Buchung fehlgeschlagen!");
            }
        }

        async function unbookSpot(level, spot, timeOfDay) {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }

            const dateKey = selectedDate.toISOString().split('T')[0];
            const publicBookingId = `${level}-${spot}-${dateKey}-${timeOfDay}`;
            const publicDocRef = doc(db, "artifacts", appId, "public", "data", PUBLIC_BOOKINGS_COLLECTION, publicBookingId);
            const privateDocRef = doc(db, "artifacts", appId, "users", userId, "parking-data", "parking-status");
            const privateKey = `${level}.${spot}.${dateKey}.${timeOfDay}`;
            
            try {
                // Check if the user is the one who booked the spot before deleting
                const publicDocSnap = await getDoc(publicDocRef);
                if (publicDocSnap.exists() && publicDocSnap.data().userId === userId) {
                    await deleteDoc(publicDocRef);
                    
                    // Also delete the booking from the user's private document
                    await updateDoc(privateDocRef, { [privateKey]: deleteField() });
                    
                    showToast("Buchung erfolgreich storniert!");
                } else {
                    showToastError("Sie können nur Ihre eigenen Buchungen stornieren.");
                }
            } catch (error) {
                console.error("Error unbooking:", error);
                showToastError("Stornierung fehlgeschlagen!");
            }
        }

        async function toggleBlockedSpot(level, spot) {
            if (!isAdmin) return;
            
            const dateKey = selectedDate.toISOString().split('T')[0];
            const blockedDocRef = doc(db, "artifacts", appId, "public", "data", BLOCKED_SPOTS_COLLECTION, `${level}-${spot}-${dateKey}`);
            
            try {
                const docSnap = await getDoc(blockedDocRef);
                if (docSnap.exists()) {
                    await deleteDoc(blockedDocRef);
                    showToast("Parkplatz entsperrt.");
                } else {
                    await setDoc(blockedDocRef, { level, spot, date: dateKey, blockedBy: userId });
                    showToast("Parkplatz gesperrt.");
                }
            } catch (error) {
                console.error("Error toggling blocked spot:", error);
                showToastError("Sperren/Entsperren fehlgeschlagen.");
            }
        }

        async function exportBookingsToCSV() {
            const dateKey = selectedDate.toISOString().split('T')[0];
            const bookedSpots = [];
            
            for (const level in globalBookings) {
                for (const spot in globalBookings[level]) {
                    const bookingData = globalBookings[level][spot][dateKey];
                    if (bookingData) {
                        if (bookingData.am) {
                            bookedSpots.push({
                                level: level,
                                spot: spot,
                                time: "Vormittag",
                                name: bookingData.am.name,
                                license: bookingData.am.license
                            });
                        }
                        if (bookingData.pm) {
                            bookedSpots.push({
                                level: level,
                                spot: spot,
                                time: "Nachmittag",
                                name: bookingData.pm.name,
                                license: bookingData.pm.license
                            });
                        }
                    }
                }
            }

            if (bookedSpots.length === 0) {
                showToastError("Keine Buchungen zum Exportieren gefunden.");
                return;
            }

            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Parkplatz,Ebene,Zeit,Name,Kennzeichen\n";
            bookedSpots.forEach(item => {
                const row = `${item.spot},${item.level},${item.time},"${item.name}","${item.license}"`;
                csvContent += row + "\n";
            });

            // Trigger download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Buchungen_${dateKey}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast("Buchungen erfolgreich exportiert!");
        }

        window.showBookingModal = async function(level, spot, timeOfDay) {
            const dateKey = selectedDate.toISOString().split('T')[0];
            const occupiedKey = `${level}.${spot}.${dateKey}.${timeOfDay}`;
            const occupiedInfo = globalBookings?.[level]?.[spot]?.[dateKey]?.[timeOfDay];

            if (occupiedInfo) {
                const userBookedThis = occupiedInfo.userId === userId;
                if (userBookedThis) {
                    await unbookSpot(level, spot, timeOfDay);
                } else {
                    showToastError("Dieser Parkplatz ist bereits von jemand anderem gebucht.");
                }
                return;
            }

            // Show modal for booking
            modal.classList.remove('hidden');
            document.getElementById('modal-title').textContent = `Parkplatz ${spot} buchen`;
            modalButtons.innerHTML = '';
            
            const timeLabel = timeOfDay === 'am' ? 'Vormittag (Vm)' : 'Nachmittag (Nm)';
            const button = document.createElement('button');
            button.type = 'submit';
            button.className = 'w-full py-3 px-6 bg-blue-600 hover:bg-blue-700 transition-colors rounded-xl font-bold';
            button.textContent = `Buchen für ${timeLabel}`;
            modalButtons.appendChild(button);
            
            // Reset email field
            emailCheckbox.checked = false;
            emailFieldContainer.classList.add('hidden');
            emailAddressInput.value = '';

            // Handle form submission
            const bookingForm = document.getElementById('booking-form');
            bookingForm.onsubmit = (event) => {
                event.preventDefault();
                const userName = userNameInput.value;
                const licensePlate = licensePlateInput.value;
                const emailAddress = emailCheckbox.checked ? emailAddressInput.value : null;

                if (userName && licensePlate && (!emailCheckbox.checked || (emailCheckbox.checked && emailAddress))) {
                    saveBooking(level, spot, timeOfDay, userName, licensePlate, emailAddress);
                    userNameInput.value = '';
                    licensePlateInput.value = '';
                    emailAddressInput.value = '';
                } else {
                    showToastError("Bitte füllen Sie alle erforderlichen Felder aus.");
                }
            };
        };
        
        function renderParkingSpots(occupiedSpots = {}, blockedSpots = {}) {
            const container = document.getElementById('parking-container');
            container.innerHTML = '';

            const dateKey = selectedDate.toISOString().split('T')[0];
            const displayDate = selectedDate.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const dateTitle = document.createElement('h2');
            dateTitle.className = 'text-xl font-semibold text-gray-100 mb-4 text-center';
            dateTitle.textContent = `Parkplatzstatus für: ${displayDate}`;
            container.appendChild(dateTitle);
            
            for (const level in parkingDataConfig) {
                const levelData = parkingDataConfig[level];
                const levelDiv = document.createElement('div');
                levelDiv.className = 'bg-gray-900 rounded-3xl p-6 mb-6 shadow-xl';
                
                // Header for the collapsible section
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center cursor-pointer mb-4';
                header.innerHTML = `
                    <h2 class="text-2xl font-semibold text-gray-100">${level}</h2>
                    <svg class="arrow-icon w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M14.707 10.707a1 1 0 01-1.414 0L10 7.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                `;
                levelDiv.appendChild(header);

                // Container for the spots, which will be collapsed
                const spotsContainer = document.createElement('div');
                spotsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 transition-all duration-300 overflow-hidden';

                // Toggle functionality for the header
                header.onclick = () => {
                    const arrow = header.querySelector('.arrow-icon');
                    spotsContainer.classList.toggle('hidden');
                    arrow.classList.toggle('rotated');
                };

                levelData.spots.forEach(spot => {
                    const spotElement = document.createElement('div');
                    spotElement.className = `spot flex flex-col justify-center items-center w-36 h-20 rounded-xl shadow-md transition-all duration-300 font-semibold p-2 border-2`;
                    
                    let categoryBorderColor = 'border-gray-400';
                    if (levelData.lvbLog.includes(spot)) {
                        categoryBorderColor = 'border-blue-600';
                    }
                    if (levelData.visitor.includes(spot)) {
                        categoryBorderColor = 'border-purple-500';
                    }
                    if (levelData.zivi && levelData.zivi.includes(spot)) {
                        categoryBorderColor = 'border-yellow-500';
                    }
                    if (levelData.ev && levelData.ev.includes(spot)) {
                        categoryBorderColor = 'border-green-500';
                    }
                    spotElement.classList.add(categoryBorderColor);

                    const isBlocked = blockedSpots[`${level}-${spot}-${dateKey}`];
                    const amData = occupiedSpots?.[level]?.[spot]?.[dateKey]?.am;
                    const pmData = occupiedSpots?.[level]?.[spot]?.[dateKey]?.pm;

                    // SVG for a minimalist car icon
                    const carSvg = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 opacity-75" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 17H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2z"></path>
                            <circle cx="7" cy="13" r="1" fill="currentColor"></circle>
                            <circle cx="17" cy="13" r="1" fill="currentColor"></circle>
                            <path d="M7 17v-2h10v2" stroke="currentColor"></path>
                        </svg>
                    `;

                    // SVG for a charging icon
                    const evSvg = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M13 14H8.5L15 20.5V14H19.5L12.5 3.5L13 14Z"></path>
                        </svg>
                    `;

                    const categoryText = [];
                    if (levelData.lvbLog.includes(spot)) categoryText.push('LVb Log');
                    if (levelData.visitor.includes(spot)) categoryText.push('Besucher');
                    if (levelData.zivi && levelData.zivi.includes(spot)) categoryText.push('ZIVI');

                    let amClass = 'free', pmClass = 'free', amDisplay = 'Vm', pmDisplay = 'Nm';
                    
                    if (isBlocked) {
                        amClass = 'blocked';
                        pmClass = 'blocked';
                        amDisplay = 'Gesperrt';
                        pmDisplay = 'Gesperrt';
                    } else {
                        if (amData) {
                            amClass = 'occupied';
                            if (isAdmin) {
                                amDisplay = `
                                    <span class="block text-xs font-normal overflow-hidden overflow-ellipsis whitespace-nowrap">${amData.name}</span>
                                    <span class="block text-xs font-normal overflow-hidden overflow-ellipsis whitespace-nowrap">${amData.license}</span>
                                `;
                            }
                        }
                        if (pmData) {
                            pmClass = 'occupied';
                            if (isAdmin) {
                                pmDisplay = `
                                    <span class="block text-xs font-normal overflow-hidden overflow-ellipsis whitespace-nowrap">${pmData.name}</span>
                                    <span class="block text-xs font-normal overflow-hidden overflow-ellipsis whitespace-nowrap">${pmData.license}</span>
                                `;
                            }
                        }
                    }
                    
                    if (isAdmin) {
                        spotElement.innerHTML = `
                            <div class="flex items-center space-x-2 text-xl font-bold">
                                ${carSvg}
                                <span>${spot}</span>
                            </div>
                            <div class="flex items-center justify-center space-x-1 mt-1 text-center font-normal">
                                ${categoryText.map(cat => `<span class="block text-xs">${cat}</span>`).join('')}
                                ${levelData.ev && levelData.ev.includes(spot) ? evSvg : ''}
                            </div>
                            <div class="flex w-full mt-2">
                                <button class="flex-1 rounded-b-lg text-sm p-1 ${isBlocked ? 'bg-red-500' : 'bg-green-500'} font-bold" onclick="toggleBlockedSpot('${level}', ${spot})">${isBlocked ? 'Entsperren' : 'Sperren'}</button>
                            </div>
                        `;
                    } else {
                        spotElement.innerHTML = `
                            <div class="flex items-center space-x-2 text-xl font-bold">
                                ${carSvg}
                                <span>${spot}</span>
                            </div>
                            <div class="flex items-center justify-center space-x-1 mt-1 text-center font-normal">
                                ${categoryText.map(cat => `<span class="block text-xs">${cat}</span>`).join('')}
                                ${levelData.ev && levelData.ev.includes(spot) ? evSvg : ''}
                            </div>
                            <div class="flex w-full mt-2">
                                <button class="flex-1 rounded-bl-lg text-sm p-1 ${amClass}" onclick="showBookingModal('${level}', ${spot}, 'am')">${amDisplay}</button>
                                <button class="flex-1 rounded-br-lg text-sm p-1 ${pmClass}" onclick="showBookingModal('${level}', ${spot}, 'pm')">${pmDisplay}</button>
                            </div>
                        `;
                    }
                    spotsContainer.appendChild(spotElement);
                });
                levelDiv.appendChild(spotsContainer);
                container.appendChild(levelDiv);
            }
        }

        // --- Real-time Firestore Listeners ---
        function setupRealtimeListeners() {
            if (!userId) {
                 console.log("User ID is not available yet. Waiting for authentication...");
                 return;
            }
            
            const bookingsColRef = collection(db, "artifacts", appId, "public", "data", PUBLIC_BOOKINGS_COLLECTION);
            const blockedColRef = collection(db, "artifacts", appId, "public", "data", BLOCKED_SPOTS_COLLECTION);
            
            // Listener for all public bookings
            onSnapshot(bookingsColRef, (querySnap) => {
                const bookingsData = {};
                querySnap.forEach((doc) => {
                    const data = doc.data();
                    const { level, spot, dateKey, timeOfDay, ...rest } = data;
                    if (!bookingsData[level]) bookingsData[level] = {};
                    if (!bookingsData[level][spot]) bookingsData[level][spot] = {};
                    if (!bookingsData[level][spot][dateKey]) bookingsData[level][spot][dateKey] = {};
                    bookingsData[level][spot][dateKey][timeOfDay] = rest;
                });
                globalBookings = bookingsData;
                renderParkingSpots(globalBookings, globalBlockedSpots);
            }, (error) => {
                console.error("Error getting real-time updates for public bookings:", error);
            });
            
            // Listener for blocked spots
            onSnapshot(blockedColRef, (querySnap) => {
                const blockedSpots = {};
                querySnap.forEach((doc) => {
                    const data = doc.data();
                    blockedSpots[`${data.level}-${data.spot}-${data.date}`] = data;
                });
                globalBlockedSpots = blockedSpots;
                renderParkingSpots(globalBookings, globalBlockedSpots);
            }, (error) => {
                console.error("Error getting real-time updates for blocked spots:", error);
            });
        }
        
        // --- Gemini API Functions ---
        
        const systemPromptChat = `
            Sie sind der Parkplatz-Assistent für das Lehrverband Logistik-Gebäude in Thun, Schweiz. Ihre Aufgabe ist es, höflich und präzise Fragen zu beantworten. Beziehen Sie sich auf die folgenden Regeln, wenn Sie Fragen zu Parkplätzen oder -richtlinien erhalten:

            1.  Die Parkplätze befinden sich im 1. und 2. Untergeschoss (UG).
            2.  Parkplätze können für den Vormittag (bis 12:00 Uhr) oder Nachmittag (ab 12:00 Uhr) gebucht werden.
            3.  LVb Log-Mitarbeiter müssen einen Parkplatz buchen.
            4.  Besucherparkplätze sind für externe Gäste reserviert und müssen ebenfalls gebucht werden.
            5.  Es gibt spezielle Parkplätze für Zivilpersonen (ZIVI).
            6.  Spezielle Parkplätze für Elektrofahrzeuge (EV) sind ebenfalls vorhanden. Diese können über die App gebucht werden.
            7.  Alle Buchungen können über diese Anwendung in Echtzeit verwaltet werden.
            8.  Nur der Parkplatz-Assistent und der Administrator können Parkplätze sperren und entsperren.
            9.  Bei Problemen oder Fragen wenden Sie sich bitte an das Gebäudemanagement.

            Antworten Sie immer auf Deutsch. Seien Sie hilfsbereit und freundlich. Wenn Sie eine Frage nicht beantworten können, entschuldigen Sie sich höflich und verweisen Sie den Benutzer auf die offizielle E-Mail-Adresse info.lvblog@vtg.admin.ch.
        `;
        
        async function callGeminiChat(userQuery) {
            const chatMessagesDiv = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            
            // Add user message to chat history and UI
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
            appendMessage(userQuery, 'user');
            
            // Add loading spinner for assistant response
            const loadingBubble = document.LcreateElement('div');
            loadingBubble.className = 'chat-bubble bg-gray-600 text-gray-300 chat-assistant';
            loadingBubble.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            chatMessagesDiv.appendChild(loadingBubble);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            
            try {
                const payload = {
                    contents: chatHistory,
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPromptChat }]
                    }
                };
                
                const response = await fetch(GEMINI_API_URL_SEARCH, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    chatHistory.push({ role: "model", parts: [{ text: text }] });
                    loadingBubble.remove();
                    appendMessage(text, 'assistant');
                } else {
                    loadingBubble.remove();
                    appendMessage("Entschuldigung, ich konnte keine Antwort finden. Bitte versuchen Sie es später erneut.", 'assistant');
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                loadingBubble.remove();
                appendMessage("Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.", 'assistant');
            }
            
            chatInput.value = '';
        }
        
        document.getElementById('chat-form').onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input').value;
            if (input) {
                callGeminiChat(input);
            }
        };
        
        function appendMessage(text, sender) {
            const chatMessagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble text-white ${sender === 'user' ? 'chat-user self-end' : 'chat-assistant self-start'}`;
            messageDiv.textContent = text;
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
        
        async function generateParkingReport() {
            const reportContentDiv = document.getElementById('report-content');
            const loadingSpinner = document.getElementById('report-loading-spinner');
            reportModal.classList.remove('hidden');
            reportContentDiv.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            
            const dateKey = selectedDate.toISOString().split('T')[0];
            const reportData = [];
            const occupiedSpots = globalBookings;

            for (const level in occupiedSpots) {
                for (const spot in occupiedSpots[level]) {
                    const bookingData = occupiedSpots[level][spot][dateKey];
                    if (bookingData) {
                        const spotData = parkingDataConfig[level].spots.find(s => s === parseInt(spot));
                        let category = 'Standard';
                        if (parkingDataConfig[level].lvbLog.includes(spotData)) category = 'LVb Log';
                        if (parkingDataConfig[level].visitor.includes(spotData)) category = 'Besucher';
                        if (parkingDataConfig[level].zivi && parkingDataConfig[level].zivi.includes(spotData)) category = 'ZIVI';
                        
                        if (bookingData.am) {
                             reportData.push({ spot, level, time: 'Vormittag', name: bookingData.am.name, category });
                        }
                        if (bookingData.pm) {
                            reportData.push({ spot, level, time: 'Nachmittag', name: bookingData.pm.name, category });
                        }
                    }
                }
            }

            if (reportData.length === 0) {
                reportContentDiv.innerHTML = `<p class="text-center text-gray-400">Für ${dateKey} wurden keine Buchungen gefunden.</p>`;
                loadingSpinner.classList.add('hidden');
                reportContentDiv.classList.remove('hidden');
                return;
            }

            const prompt = `Erstelle einen zusammenfassenden Bericht basierend auf den folgenden Parkplatzbuchungsdaten für den ${dateKey}. Konzentriere dich auf die Gesamtauslastung, häufig genutzte Parkplätze und die Verteilung nach Kategorie (LVb Log, Besucher, ZIVI).
            
            Buchungsdaten (JSON):
            ${JSON.stringify(reportData, null, 2)}
            
            Gib eine informative, prägnante Zusammenfassung als Text aus.`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.2,
                    }
                };

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    reportContentDiv.innerHTML = `<p class="text-left whitespace-pre-wrap">${text}</p>`;
                } else {
                    reportContentDiv.innerHTML = `<p class="text-center text-gray-400">Entschuldigung, der Bericht konnte nicht erstellt werden.</p>`;
                }
            } catch (error) {
                console.error("Error calling Gemini API for report:", error);
                reportContentDiv.innerHTML = `<p class="text-center text-red-400">Ein Fehler ist bei der Berichtsgenerierung aufgetreten.</p>`;
            } finally {
                loadingSpinner.classList.add('hidden');
                reportContentDiv.classList.remove('hidden');
            }
        }

        // Initial render of the header
        renderHeader();
    </script>
</body>
</html>
